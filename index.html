<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Staff Score Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ color-scheme: dark; }
    body{ background:#050816; }
    .glass{ background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.07); border-radius:16px; }
    .btn{ background:#4f46e5; }
    .btn:hover{ filter:brightness(1.05); }
    .chip{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); border-radius:999px; padding:.25rem .6rem; font-size:.75rem; }
    .tbl th,.tbl td{ padding:.6rem .7rem; border-bottom:1px solid rgba(255,255,255,.06); }
  </style>
</head>

<body class="text-slate-100">
  <div class="max-w-6xl mx-auto p-6">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h1 class="text-3xl font-bold">Staff Score Dashboard</h1>
        <div class="text-sm text-slate-400 mt-1">Live view • Monthly + Weekly • Quarterly • Incidents • Private login</div>
      </div>

      <div class="flex gap-2 items-center flex-wrap justify-end">
        <span id="userChip" class="chip hidden"></span>
        <button id="resetChip" class="chip hidden">Reset Password</button>
        <button id="logoutBtn" class="chip hidden">Logout</button>
      </div>
    </div>

    <!-- LOGIN -->
    <section id="loginSection" class="glass mt-6 p-6">
      <div class="grid md:grid-cols-2 gap-6 items-center">
        <div>
          <h2 class="text-xl font-semibold">Login</h2>
          <p class="text-sm text-slate-400 mt-2">Use your <b>StaffID</b> + password.</p>
          <p class="text-xs text-slate-500 mt-2">If login fails, ask admin to run: <b>Weekly Score Tools → Initialize / Sync AUTH</b></p>
          <p id="loginErr" class="text-sm text-red-400 mt-3 hidden"></p>

          <!-- ✅ reset link on login -->
          <button id="loginResetLink" class="chip mt-4">Reset Password (default only)</button>
        </div>
        <div class="space-y-3">
          <input id="staffId" class="w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2 outline-none" placeholder="StaffID e.g. S001" />
          <input id="password" type="password" class="w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2 outline-none" placeholder="Password" />
          <button id="loginBtn" class="w-full btn rounded-xl py-2 font-semibold">Login</button>
        </div>
      </div>

      <!-- ✅ login reset panel -->
      <div id="loginResetPanel" class="glass p-4 mt-6 hidden">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="font-semibold">Reset Password (Login)</h3>
            <div class="text-xs text-slate-500 mt-1">
              Works only if your account is still using default password <b>mcw@1234</b>.
            </div>
          </div>
          <button id="loginResetClose" class="chip">Close</button>
        </div>

        <div class="mt-4 grid md:grid-cols-3 gap-3">
          <input id="lr_staff" class="w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2 outline-none" placeholder="StaffID e.g. S019" />
          <input id="lr_new" type="password" class="w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2 outline-none" placeholder="New password (min 4 char)" />
          <button id="loginResetBtn" class="btn rounded-xl py-2 font-semibold">Reset Now</button>
        </div>

        <div class="text-xs text-slate-500 mt-2">Old password is fixed: <b>mcw@1234</b></div>
        <div id="loginResetMsg" class="text-sm mt-3 hidden"></div>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashSection" class="hidden">
      <div class="glass mt-6 p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h2 class="text-xl font-semibold">Your Live Scores</h2>
            <div id="selMonthTxt" class="text-sm text-slate-400 mt-1"></div>
          </div>

          <div class="flex flex-wrap items-center gap-2">
            <select id="monthSelect" class="bg-slate-950 border border-slate-800 rounded-xl px-3 py-2 outline-none"></select>
            <button id="refreshBtn" class="chip">Refresh</button>
            <button id="exportMyBtn" class="chip">Export My Report</button>
            <button id="exportAllBtn" class="chip">Export CSV</button>
          </div>
        </div>

        <div id="warnBox" class="mt-3 text-sm text-amber-300 hidden"></div>

        <div class="grid md:grid-cols-4 gap-4 mt-6">
          <div class="glass p-4">
            <div class="text-xs text-slate-400">Monthly Score</div>
            <div id="monthlyScore" class="text-3xl font-bold mt-2">—</div>
            <div class="text-xs text-slate-500 mt-1">Shown out of 5</div>
          </div>
          <div class="glass p-4">
            <div class="text-xs text-slate-400">Weekly Score</div>
            <div id="weeklyScore" class="text-3xl font-bold mt-2">—</div>
            <div id="weeklyHint" class="text-xs text-slate-500 mt-1">Average of all weeks</div>
          </div>
          <div class="glass p-4">
            <div class="text-xs text-slate-400">Final Average</div>
            <div id="finalAvg" class="text-3xl font-bold mt-2">—</div>
            <div class="text-xs text-slate-500 mt-1">(Monthly + Weekly) / 2</div>
          </div>
          <div class="glass p-4">
            <div class="text-xs text-slate-400">Quarter Score</div>
            <div id="quarterScore" class="text-3xl font-bold mt-2">—</div>
            <div id="quarterHint" class="text-xs text-slate-500 mt-1">Quarter months auto</div>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4 mt-6">
          <div class="glass p-4">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold">Your Incidents</h3>
              <span class="chip">Status only (notes not counted)</span>
            </div>
            <div class="text-xs text-slate-500 mt-1">Staff | Date | Incident | Notes</div>
            <div class="overflow-auto mt-3">
              <table class="tbl w-full text-sm">
                <thead class="text-slate-300">
                  <tr>
                    <th class="text-left">Staff</th>
                    <th class="text-left">Date</th>
                    <th class="text-left">Incident</th>
                    <th class="text-left">Notes</th>
                  </tr>
                </thead>
                <tbody id="myIncBody"></tbody>
              </table>
            </div>
            <div id="myIncEmpty" class="text-sm text-emerald-300 mt-3 hidden">No incidents ✅</div>
            <div id="myIncLoading" class="text-xs text-slate-500 mt-3">Loading incidents…</div>
          </div>

          <div id="pwCard" class="glass p-4 hidden">
            <h3 class="font-semibold">Change Password</h3>
            <div class="text-xs text-slate-500 mt-1">First login with default password: you must change it.</div>
            <div class="mt-4 space-y-3">
              <input id="oldPass" type="password" class="w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2 outline-none" placeholder="Old password" />
              <input id="newPass" type="password" class="w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2 outline-none" placeholder="New password (min 4 char)" />
              <button id="pwBtn" class="w-full btn rounded-xl py-2 font-semibold">Update Password</button>
              <div id="pwMsg" class="text-sm mt-2 hidden"></div>
            </div>
          </div>
        </div>

        <div id="resetPanel" class="glass p-4 mt-6 hidden">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-semibold">Reset Password</h3>
              <div class="text-xs text-slate-500 mt-1">Use default password as old password: <b>mcw@1234</b></div>
            </div>
            <button id="resetClose" class="chip">Close</button>
          </div>

          <div class="mt-4 grid md:grid-cols-3 gap-3">
            <input id="resetOld" type="password" class="w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2 outline-none" placeholder="Old password (mcw@1234)" />
            <input id="resetNew" type="password" class="w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2 outline-none" placeholder="New password (min 4 char)" />
            <button id="resetBtn" class="btn rounded-xl py-2 font-semibold">Reset Now</button>
          </div>
          <div id="resetMsg" class="text-sm mt-3 hidden"></div>
        </div>

        <div class="glass p-4 mt-6">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-semibold">All Incidents (Everyone)</h3>
              <div class="text-xs text-slate-500 mt-1">Staff | Date | Incident | Notes</div>
            </div>
            <span class="chip">Only Status != Normal</span>
          </div>
          <div class="overflow-auto mt-3">
            <table class="tbl w-full text-sm">
              <thead class="text-slate-300">
                <tr>
                  <th class="text-left">Staff</th>
                  <th class="text-left">Date</th>
                  <th class="text-left">Incident</th>
                  <th class="text-left">Notes</th>
                </tr>
              </thead>
              <tbody id="allIncBody"></tbody>
            </table>
          </div>
          <div id="allIncEmpty" class="text-sm text-emerald-300 mt-3 hidden">No incidents found ✅</div>
          <div id="allIncLoading" class="text-xs text-slate-500 mt-3">Loading incidents…</div>
        </div>

        <div class="glass p-4 mt-6">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-semibold">All Staff Scores</h3>
              <div class="text-xs text-slate-500 mt-1">Sorted by Final score (highest first)</div>
            </div>
            <input id="searchBox" class="bg-slate-950 border border-slate-800 rounded-xl px-3 py-2 outline-none text-sm"
              placeholder="Search StaffID or Name..." />
          </div>

          <div class="overflow-auto mt-3">
            <table class="tbl w-full text-sm">
              <thead class="text-slate-300">
                <tr>
                  <th class="text-left">Rank</th>
                  <th class="text-left">StaffID</th>
                  <th class="text-left">Name</th>
                  <th class="text-left">Monthly</th>
                  <th class="text-left">Weekly</th>
                  <th class="text-left">Final</th>
                  <th class="text-left">Incidents</th>
                </tr>
              </thead>
              <tbody id="boardBody"></tbody>
            </table>
          </div>
          <div id="boardFoot" class="text-xs text-slate-500 mt-2"></div>
          <div id="boardLoading" class="text-xs text-slate-500 mt-2">Loading leaderboard…</div>
        </div>
      </div>
    </section>

  </div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyjbzXjSYv4ydKwE1RSdPlVhiokmUghqSLQ5CxWdDqVGOZAeuXD9rIH67fLMnG57vo4/exec";

const S = {
  token: localStorage.getItem("ss_token") || "",
  staffId: localStorage.getItem("ss_staffId") || "",
  name: localStorage.getItem("ss_name") || "",
  month: localStorage.getItem("ss_month") || ""
};

const $ = id => document.getElementById(id);

function jsonp(params){
  return new Promise((resolve,reject)=>{
    const cb = "cb_" + Math.random().toString(36).slice(2);
    params.callback = cb;
    const qs = new URLSearchParams(params).toString();
    const src = WEBAPP_URL + "?" + qs;

    window[cb] = (data) => {
      try { delete window[cb]; } catch(e){}
      script.remove();
      resolve(data);
    };

    const script = document.createElement("script");
    script.src = src;
    script.onerror = () => {
      try { delete window[cb]; } catch(e){}
      script.remove();
      reject(new Error("Network / blocked WebApp access"));
    };
    document.body.appendChild(script);
  });
}

function showLogin(msg){
  $("loginSection").classList.remove("hidden");
  $("dashSection").classList.add("hidden");
  $("userChip").classList.add("hidden");
  $("resetChip").classList.add("hidden");
  $("logoutBtn").classList.add("hidden");
  if (msg){
    $("loginErr").textContent = msg;
    $("loginErr").classList.remove("hidden");
  } else {
    $("loginErr").classList.add("hidden");
  }
}

function showDash(){
  $("loginSection").classList.add("hidden");
  $("dashSection").classList.remove("hidden");
  $("userChip").textContent = `${S.staffId} • ${S.name || ""}`.trim();
  $("userChip").classList.remove("hidden");
  $("logoutBtn").classList.remove("hidden");
}

function numOrDash(v){
  return (v===null || v===undefined || v==="" || Number.isNaN(v)) ? "—" : Number(v).toFixed(2);
}

function setWarn(text){
  if (!text){
    $("warnBox").classList.add("hidden");
    $("warnBox").textContent = "";
    return;
  }
  $("warnBox").textContent = "⚠️ " + text;
  $("warnBox").classList.remove("hidden");
}

async function loadMonths(){
  const res = await jsonp({ action:"getMonths" });
  if (!res.ok) throw new Error(res.error || "Failed getMonths");

  const months = res.months || [];
  const sel = $("monthSelect");
  sel.innerHTML = "";

  const extra = ["All","Weekly"];
  const full = extra.concat(months);

  const chosen = (S.month && full.includes(S.month))
    ? S.month
    : (months.length ? months[months.length - 1] : "All");

  S.month = chosen;
  localStorage.setItem("ss_month", chosen);

  for (const m of full){
    const opt = document.createElement("option");
    opt.value = m;
    opt.textContent = m;
    if (m === chosen) opt.selected = true;
    sel.appendChild(opt);
  }

  $("selMonthTxt").textContent = "Selected Month: " + chosen;
}

function renderIncidentsTable(tbody, list){
  tbody.innerHTML = "";
  for (const x of list){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="text-slate-200">${escapeHtml(x.staffName || x.staffId)}</td>
      <td class="text-slate-300">${escapeHtml(x.date || "")}</td>
      <td class="text-rose-300 font-semibold">${escapeHtml(x.incident || "")}</td>
      <td class="text-slate-300">${escapeHtml(x.notes || "")}</td>
    `;
    tbody.appendChild(tr);
  }
}

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function setPwUI(needsPasswordChange){
  if (needsPasswordChange){
    $("pwCard").classList.remove("hidden");
    $("resetChip").classList.add("hidden");
    $("resetPanel").classList.add("hidden");
  } else {
    $("pwCard").classList.add("hidden");
    $("resetChip").classList.remove("hidden");
  }
}

async function loadDashboardOnly(){
  $("selMonthTxt").textContent = "Selected Month: " + S.month;

  const res = await jsonp({
    action:"dashboard",
    token:S.token,
    staffId:S.staffId,
    month:S.month
  });

  if (!res.ok) throw new Error(res.error || "dashboard failed");

  $("monthlyScore").textContent = numOrDash(res.monthlyScore);
  $("weeklyScore").textContent = numOrDash(res.weeklyScore);
  $("finalAvg").textContent = numOrDash(res.finalAvg);
  $("quarterScore").textContent = numOrDash(res.quarterScore);

  const qh = (res.quarterMonths && res.quarterMonths.length) ? res.quarterMonths.join(", ") : "—";
  $("quarterHint").textContent = "Months: " + qh;

  if (res.latestWeek && res.latestWeek.weekStart && res.latestWeek.weekEnd){
    $("weeklyHint").textContent = `Avg of ${res.weeksCount} weeks • Latest: ${new Date(res.latestWeek.weekStart).toDateString()} → ${new Date(res.latestWeek.weekEnd).toDateString()}`;
  } else {
    $("weeklyHint").textContent = `Avg of ${res.weeksCount} weeks`;
  }

  if ((S.month !== "All" && S.month !== "Weekly") && res.monthlyScore === null){
    setWarn("Your StaffID is not found in this month tab. Add your row in the month sheet to show monthly score.");
  } else {
    setWarn("");
  }

  setPwUI(!!res.needsPasswordChange);

  // My incidents from dashboard (small list)
  const myInc = res.myIncidents || [];
  if (!myInc.length){
    $("myIncEmpty").classList.remove("hidden");
    $("myIncBody").innerHTML = "";
  } else {
    $("myIncEmpty").classList.add("hidden");
    renderIncidentsTable($("myIncBody"), myInc);
  }
}

async function loadIncidentsBackground(){
  $("myIncLoading").classList.remove("hidden");
  $("allIncLoading").classList.remove("hidden");

  try{
    const res = await jsonp({
      action:"incidents",
      token:S.token,
      staffId:S.staffId,
      month:S.month
    });
    if (!res.ok) throw new Error(res.error || "incidents failed");

    const all = res.all || [];
    if (!all.length){
      $("allIncEmpty").classList.remove("hidden");
      $("allIncBody").innerHTML = "";
    } else {
      $("allIncEmpty").classList.add("hidden");
      renderIncidentsTable($("allIncBody"), all);
    }
  } finally {
    $("myIncLoading").classList.add("hidden");
    $("allIncLoading").classList.add("hidden");
  }
}

let leaderboardCache = [];
async function loadLeaderboardBackground(){
  $("boardLoading").classList.remove("hidden");
  try{
    const res = await jsonp({
      action:"leaderboard",
      token:S.token,
      staffId:S.staffId,
      month:S.month
    });
    if (!res.ok) throw new Error(res.error || "leaderboard failed");

    leaderboardCache = res.rows || [];
    renderLeaderboard(leaderboardCache);
  } finally {
    $("boardLoading").classList.add("hidden");
  }
}

function renderLeaderboard(list){
  const tb = $("boardBody");
  tb.innerHTML = "";

  for (const r of list){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.rank || ""}</td>
      <td class="text-slate-200">${escapeHtml(r.staffId)}</td>
      <td class="text-slate-200">${escapeHtml(r.staffName || "")}</td>
      <td>${r.monthly==null ? "—" : Number(r.monthly).toFixed(2)}</td>
      <td>${r.weekly==null ? "—" : Number(r.weekly).toFixed(2)}</td>
      <td class="font-semibold">${r.final==null ? "—" : Number(r.final).toFixed(2)}</td>
      <td class="text-slate-300">${r.incidents || 0}</td>
    `;
    tb.appendChild(tr);
  }

  $("boardFoot").textContent = `Showing ${list.length} of ${leaderboardCache.length} staff`;
}

function applySearch(){
  const q = $("searchBox").value.trim().toLowerCase();
  if (!q) return renderLeaderboard(leaderboardCache);
  const filtered = leaderboardCache.filter(x =>
    (x.staffId||"").toLowerCase().includes(q) ||
    (x.staffName||"").toLowerCase().includes(q)
  );
  renderLeaderboard(filtered);
}

function downloadCSV(filename, rows){
  const csv = rows.map(r => r.map(x => `"${String(x??"").replaceAll('"','""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

function exportAllCSV(){
  const rows = [
    ["Rank","StaffID","Name","Monthly","Weekly","Final","Incidents"],
    ...leaderboardCache.map(r => [
      r.rank, r.staffId, r.staffName,
      r.monthly ?? "", r.weekly ?? "", r.final ?? "", r.incidents ?? 0
    ])
  ];
  downloadCSV(`StaffScores_${S.month}.csv`, rows);
}

async function exportMyReport(){
  const dash = await jsonp({ action:"dashboard", token:S.token, staffId:S.staffId, month:S.month });
  if (!dash.ok) throw new Error(dash.error || "export dashboard failed");

  const inc = dash.myIncidents || [];
  const rows = [
    ["StaffID", S.staffId],
    ["Name", S.name || ""],
    ["Month", S.month],
    ["MonthlyScore(out of 4)", dash.monthlyScore ?? ""],
    ["WeeklyScore(out of 4)", dash.weeklyScore ?? ""],
    ["FinalAverage", dash.finalAvg ?? ""],
    ["QuarterScore", dash.quarterScore ?? ""],
    ["QuarterMonths", (dash.quarterMonths||[]).join(" | ")],
    [],
    ["My Incidents (Status only, notes not counted)"],
    ["Date","Incident","Notes"],
    ...inc.map(x => [x.date, x.incident, x.notes])
  ];
  downloadCSV(`MyReport_${S.staffId}_${S.month}.csv`, rows);
}

/* =========================
   Events
========================= */

// ✅ login reset
$("loginResetLink").addEventListener("click", ()=>{
  $("loginResetPanel").classList.toggle("hidden");
  $("lr_staff").value = $("staffId").value.trim().toUpperCase();
});
$("loginResetClose").addEventListener("click", ()=> $("loginResetPanel").classList.add("hidden"));

$("loginResetBtn").addEventListener("click", async ()=>{
  const staffId = $("lr_staff").value.trim().toUpperCase();
  const newPassword = $("lr_new").value;

  $("loginResetMsg").classList.add("hidden");
  try{
    const res = await jsonp({
      action:"resetPasswordLogin",
      staffId,
      oldPassword:"mcw@1234",
      newPassword
    });
    if (!res.ok) throw new Error(res.error || "Reset failed");

    $("loginResetMsg").textContent = "Password reset ✅ Now login with new password.";
    $("loginResetMsg").className = "text-sm mt-3 text-emerald-300";
    $("loginResetMsg").classList.remove("hidden");
  } catch(err){
    $("loginResetMsg").textContent = err.message || String(err);
    $("loginResetMsg").className = "text-sm mt-3 text-red-300";
    $("loginResetMsg").classList.remove("hidden");
  }
});

$("loginBtn").addEventListener("click", async ()=>{
  try{
    $("loginErr").classList.add("hidden");

    const staffId = $("staffId").value.trim().toUpperCase(); // ✅ case-insensitive
    const password = $("password").value;

    const res = await jsonp({ action:"login", staffId, password });
    if (!res.ok) throw new Error(res.error || "Login failed");

    S.token = res.token;
    S.staffId = (res.staffId || staffId).toUpperCase();
    S.name = res.name || "";
    localStorage.setItem("ss_token", S.token);
    localStorage.setItem("ss_staffId", S.staffId);
    localStorage.setItem("ss_name", S.name);

    showDash();
    await loadMonths();

    // ✅ FAST: show dashboard first (no waiting)
    await loadDashboardOnly();

    // ✅ background load (doesn't block)
    loadIncidentsBackground();
    loadLeaderboardBackground();

  } catch(err){
    showLogin(err.message || String(err));
  }
});

$("logoutBtn").addEventListener("click", ()=>{
  localStorage.removeItem("ss_token");
  localStorage.removeItem("ss_staffId");
  localStorage.removeItem("ss_name");
  localStorage.removeItem("ss_month");
  location.reload();
});

$("monthSelect").addEventListener("change", async ()=>{
  S.month = $("monthSelect").value;
  localStorage.setItem("ss_month", S.month);

  await loadDashboardOnly();
  loadIncidentsBackground();
  loadLeaderboardBackground();
});

$("refreshBtn").addEventListener("click", async ()=>{
  await loadDashboardOnly();
  loadIncidentsBackground();
  loadLeaderboardBackground();
});

// change password (forced)
$("pwBtn").addEventListener("click", async ()=>{
  const oldPassword = $("oldPass").value;
  const newPassword = $("newPass").value;
  $("pwMsg").classList.add("hidden");

  try{
    const res = await jsonp({
      action:"changePassword",
      staffId:S.staffId,
      oldPassword,
      newPassword
    });
    if (!res.ok) throw new Error(res.error || "Password update failed");

    $("pwMsg").textContent = "Password updated ✅";
    $("pwMsg").className = "text-sm mt-2 text-emerald-300";
    $("pwMsg").classList.remove("hidden");

    $("pwCard").classList.add("hidden");
    $("resetChip").classList.remove("hidden");

    await loadDashboardOnly();

  } catch(err){
    $("pwMsg").textContent = err.message || String(err);
    $("pwMsg").className = "text-sm mt-2 text-red-300";
    $("pwMsg").classList.remove("hidden");
  }
});

// reset password chip/panel
$("resetChip").addEventListener("click", ()=> $("resetPanel").classList.toggle("hidden"));
$("resetClose").addEventListener("click", ()=> $("resetPanel").classList.add("hidden"));

$("resetBtn").addEventListener("click", async ()=>{
  const oldPassword = $("resetOld").value;
  const newPassword = $("resetNew").value;

  $("resetMsg").classList.add("hidden");

  try{
    const res = await jsonp({
      action:"resetPassword",
      token: S.token,
      staffId: S.staffId,
      oldPassword,
      newPassword
    });
    if (!res.ok) throw new Error(res.error || "Reset failed");

    $("resetMsg").textContent = "Password reset ✅";
    $("resetMsg").className = "text-sm mt-3 text-emerald-300";
    $("resetMsg").classList.remove("hidden");

    $("resetOld").value = "";
    $("resetNew").value = "";

  } catch(err){
    $("resetMsg").textContent = err.message || String(err);
    $("resetMsg").className = "text-sm mt-3 text-red-300";
    $("resetMsg").classList.remove("hidden");
  }
});

$("searchBox").addEventListener("input", applySearch);
$("exportAllBtn").addEventListener("click", exportAllCSV);
$("exportMyBtn").addEventListener("click", exportMyReport);

/* Boot */
(async function boot(){
  if (!S.token || !S.staffId){
    showLogin();
    return;
  }

  try{
    S.staffId = S.staffId.trim().toUpperCase();
    showDash();
    await loadMonths();

    await loadDashboardOnly();
    loadIncidentsBackground();
    loadLeaderboardBackground();

  } catch (e){
    showLogin("Session expired. Please login again.");
  }
})();
</script>
</body>
</html>
