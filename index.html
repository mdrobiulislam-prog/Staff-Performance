<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Staff Score Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root { color-scheme: dark; }
    body {
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(99,102,241,.18), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(14,165,233,.12), transparent 55%),
        #070b18;
    }

    /* ✅ never block clicks */
    * { pointer-events: auto; }

    .card { background: rgba(15, 23, 42, .72); border: 1px solid rgba(148,163,184,.14); box-shadow: 0 10px 35px rgba(0,0,0,.35); }
    .chip { border: 1px solid rgba(148,163,184,.18); background: rgba(2,6,23,.55); }
    .btn { border: 1px solid rgba(148,163,184,.18); background: rgba(2,6,23,.55); cursor:pointer; }
    .btn:hover { background: rgba(30,41,59,.6); }
    .btn-primary { background: rgba(99,102,241,.85); border-color: rgba(99,102,241,.35); cursor:pointer; }
    .btn-primary:hover { background: rgba(99,102,241,.95); }
    .inp { background: rgba(2,6,23,.55); border: 1px solid rgba(148,163,184,.18); }
    .muted { color: rgb(148 163 184); }
    .danger { color: rgb(248 113 113); }
    .warn { color: rgb(251 191 36); }
    .ok { color: rgb(74 222 128); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .toast { position: fixed; right: 16px; bottom: 16px; z-index: 9999; pointer-events:none; }
    .toast > * { pointer-events:auto; }
    .hidden { display:none !important; }

    @media (max-width: 640px){
      .gridCards { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; }
    }

    #loginCard { position: relative; z-index: 5000; }
    #btnLogin { position: relative; z-index: 6000; pointer-events: auto !important; cursor: pointer !important; }
  </style>
</head>

<body class="min-h-screen text-slate-100">
  <div class="max-w-[1200px] mx-auto px-4 py-10">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h1 class="text-3xl font-bold tracking-tight">Staff Score Dashboard</h1>
        <p class="muted mt-1 text-sm">Live view • Monthly + Weekly • Quarterly • Incidents • Private login</p>
      </div>
      <div id="topRight" class="hidden items-center gap-2">
        <div class="chip rounded-full px-3 py-1 text-xs">
          <span id="whoami" class="muted"></span>
        </div>
        <button id="btnLogout" class="btn rounded-full px-3 py-1 text-xs" type="button">Logout</button>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="loginCard" class="card rounded-2xl mt-8 p-6">
      <div class="grid md:grid-cols-2 gap-6 items-center">
        <div>
          <h2 class="text-lg font-semibold">Login</h2>
          <p class="muted text-sm mt-1">Use your StaffID + password.</p>
          <p class="muted text-xs mt-3">(Default password is NOT shown here. You will share it manually to staff.)</p>
          <p class="muted text-xs mt-2">If login fails, ask admin to re-deploy Web App with access = <b>Anyone</b>.</p>
        </div>

        <div class="space-y-3">
          <div>
            <label class="muted text-xs">StaffID</label>
            <input id="loginStaffId" class="inp w-full rounded-xl px-3 py-2 mt-1 outline-none" placeholder="e.g. S016" />
          </div>
          <div>
            <label class="muted text-xs">Password</label>
            <input id="loginPass" type="password" class="inp w-full rounded-xl px-3 py-2 mt-1 outline-none" placeholder="••••••••" />
          </div>

          <button id="btnLogin" class="btn-primary w-full rounded-xl py-2 font-semibold" type="button">Login</button>

          <div id="loginErr" class="text-sm danger hidden"></div>

          <!-- extra hint shown only when fetch blocked -->
          <div id="deployHint" class="text-xs warn hidden">
            ⚠️ API blocked. In Apps Script deployment set:
            <b>Who has access = Anyone</b> (or Anyone with link), then Deploy again.
          </div>
        </div>
      </div>
    </div>

    <!-- DASHBOARD (kept minimal here; your API should return next data after login) -->
    <div id="dash" class="hidden">
      <div class="card rounded-2xl mt-8 p-5">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
          <div>
            <h3 class="font-semibold">Logged in ✅</h3>
            <div class="muted text-xs mt-1">Now API is reachable. You can connect the remaining dashboard actions.</div>
          </div>
          <button id="btnBackToLogin" class="btn rounded-xl px-3 py-2 text-sm" type="button">Back</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast">
    <div id="toast" class="hidden card rounded-xl px-4 py-3 text-sm"></div>
  </div>

<script>
  // ✅ YOUR WEB APP URL (exactly as you sent)
  const GAS_URL = "https://script.google.com/macros/s/AKfycbwWbjQVOy1PQfQvro4H5ogz2_WBpoZiSwCCg2zRbAtCmehqj3hB7DKcGKHikWgHfASF/exec";

  const $ = (id) => document.getElementById(id);

  function toast(msg){
    const el = $("toast");
    el.textContent = msg;
    el.classList.remove("hidden");
    setTimeout(()=> el.classList.add("hidden"), 2500);
  }

  function showErr(msg){
    $("loginErr").textContent = msg;
    $("loginErr").classList.remove("hidden");
  }

  function hideErr(){
    $("loginErr").classList.add("hidden");
    $("loginErr").textContent = "";
  }

  // Stronger fetch handler (shows proper reason when deployment is not public)
  async function api(action, payload = {}) {
    let r;
    try {
      r = await fetch(GAS_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action, ...payload }),
        redirect: "follow",
        cache: "no-store"
      });
    } catch (e) {
      // Network/CORS/deploy restriction
      $("deployHint").classList.remove("hidden");
      throw new Error("Failed to fetch (Web App access is not public or blocked).");
    }

    const txt = await r.text();

    // Sometimes Apps Script returns HTML login page when access is restricted
    if (txt.trim().startsWith("<!DOCTYPE html") || txt.includes("<html")) {
      $("deployHint").classList.remove("hidden");
      throw new Error("Web App returned HTML (deployment access not set to Anyone).");
    }

    let data;
    try {
      data = JSON.parse(txt);
    } catch (e) {
      throw new Error("API returned non-JSON response.");
    }
    return data;
  }

  async function doLogin(){
    hideErr();
    $("deployHint").classList.add("hidden");

    const staffId = $("loginStaffId").value.trim().toUpperCase(); // ✅ force uppercase
    const password = $("loginPass").value;

    if (!staffId || !password) return showErr("Please enter StaffID and password.");

    $("btnLogin").disabled = true;
    $("btnLogin").textContent = "Logging in...";
    toast("Logging in…");

    try {
      const res = await api("login", { staffId, password });

      if (!res || res.success !== true) {
        throw new Error(res?.error || "Login failed");
      }

      // ✅ success UI
      $("whoami").textContent = `${staffId}${res.name ? " • " + res.name : ""}`;
      $("topRight").classList.remove("hidden");
      $("loginCard").classList.add("hidden");
      $("dash").classList.remove("hidden");
      toast("Login success ✅");
    } catch (e) {
      showErr(e.message || String(e));
    } finally {
      $("btnLogin").disabled = false;
      $("btnLogin").textContent = "Login";
    }
  }

  function doLogout(){
    $("topRight").classList.add("hidden");
    $("dash").classList.add("hidden");
    $("loginCard").classList.remove("hidden");
    $("loginPass").value = "";
    hideErr();
    $("deployHint").classList.add("hidden");
  }

  window.addEventListener("DOMContentLoaded", () => {
    $("btnLogin").addEventListener("click", doLogin);

    $("loginPass").addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });
    $("loginStaffId").addEventListener("input", (e)=>{ e.target.value = e.target.value.toUpperCase(); });

    $("btnLogout").addEventListener("click", doLogout);
    $("btnBackToLogin").addEventListener("click", doLogout);
  });
</script>
</body>
</html>
