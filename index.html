<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Staff Score Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root { color-scheme: dark; }
    body { background:#020617; }
    .card { background:#0b1120; border:1px solid #1f2937; border-radius:16px; }
    .chip { background:#0f172a; border:1px solid #1f2937; border-radius:999px; padding:.25rem .65rem; font-size:.8rem; }
    .muted { color:#94a3b8; }
    .bad { color:#fb7185; }
    .warn { color:#fbbf24; }
    .good { color:#34d399; }
    .btn { background:#4f46e5; }
    .btn:hover { filter: brightness(1.1); }
    .inp { background:#020617; border:1px solid #1f2937; border-radius:12px; padding:.6rem .75rem; outline:none; width:100%; }
    .inp:focus { border-color:#6366f1; }
    select.inp { padding-right:2rem; }
    .skeleton {
      background: linear-gradient(90deg, rgba(255,255,255,.05), rgba(255,255,255,.10), rgba(255,255,255,.05));
      background-size: 200% 100%;
      animation: shimmer 1.1s infinite linear;
      border-radius: 12px;
      height: 12px;
    }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  </style>
</head>

<body class="text-slate-100">
  <div class="max-w-6xl mx-auto p-4 md:p-8">

    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold">Staff Score Dashboard</h1>
        <div class="muted text-sm mt-1">Live view • Monthly + Weekly • Quarterly • Incidents • Private login</div>
      </div>
      <div id="topRight" class="hidden gap-2 items-center">
        <span id="who" class="chip"></span>
        <button id="btnLogout" class="chip">Logout</button>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="loginCard" class="card p-5 md:p-6">
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <div class="text-lg font-semibold">Login</div>
          <div class="muted text-sm mt-1">Use your <b>StaffID</b> + password.</div>
          <div class="muted text-xs mt-2">
            If login fails, ask admin to run: <b>Weekly Score Tools → Initialize / Sync AUTH</b>
          </div>
        </div>
        <div class="space-y-3">
          <input id="staffId" class="inp" placeholder="StaffID (e.g., S001)" />
          <input id="password" type="password" class="inp" placeholder="Password" />
          <button id="btnLogin" class="w-full btn py-2 rounded-xl font-semibold">Login</button>
          <div id="loginMsg" class="text-sm muted"></div>
        </div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dash" class="hidden space-y-5">

      <div class="card p-5 md:p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <div class="text-lg font-semibold">Your Live Scores</div>
            <div id="subtitle" class="muted text-sm mt-1">—</div>
            <div id="dashMsg" class="text-sm mt-2"></div>
          </div>
          <div class="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center">
            <select id="monthSelect" class="inp"></select>
            <div class="flex gap-2">
              <button id="btnRefresh" class="chip">Refresh</button>
            </div>
          </div>
        </div>
      </div>

      <!-- SCORE CARDS -->
      <div class="grid md:grid-cols-4 gap-4">
        <div class="card p-4">
          <div class="muted text-xs">Monthly Score</div>
          <div id="mScore" class="text-3xl font-bold mt-2">—</div>
          <div id="mHint" class="muted text-xs mt-1">Shown out of 4</div>
        </div>
        <div class="card p-4">
          <div class="muted text-xs">Weekly Score</div>
          <div id="wScore" class="text-3xl font-bold mt-2">—</div>
          <div id="wHint" class="muted text-xs mt-1">Shown out of 4</div>
        </div>
        <div class="card p-4">
          <div class="muted text-xs">Final Average</div>
          <div id="fScore" class="text-3xl font-bold mt-2">—</div>
          <div id="fHint" class="muted text-xs mt-1">(Monthly + Weekly) / 2</div>
        </div>
        <div class="card p-4">
          <div class="muted text-xs">Quarter Score</div>
          <div id="qScore" class="text-3xl font-bold mt-2">—</div>
          <div id="qHint" class="muted text-xs mt-1">Auto from quarter months</div>
        </div>
      </div>

      <!-- INCIDENTS + PASSWORD -->
      <div class="grid md:grid-cols-2 gap-4">
        <div class="card p-5">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Incidents</div>
            <span class="chip">Non-Normal only</span>
          </div>
          <div id="incidents" class="mt-3 text-sm muted">—</div>
        </div>

        <div class="card p-5">
          <div class="font-semibold">Change Password</div>
          <div class="muted text-sm mt-1">Set your own password after first login.</div>
          <div class="mt-3 space-y-2">
            <input id="oldPass" type="password" class="inp" placeholder="Old password" />
            <input id="newPass" type="password" class="inp" placeholder="New password (min 4 char)" />
            <button id="btnChangePass" class="w-full btn py-2 rounded-xl font-semibold">Update Password</button>
            <div id="passMsg" class="text-sm muted"></div>
          </div>
        </div>
      </div>

      <div class="muted text-xs text-center pt-2">
        Note: Month dropdown is generated from month sheets containing headers <b>MonthStart</b> + <b>StaffID</b>.
      </div>
    </div>
  </div>

<script>
  // ✅ Your Apps Script Web App URL
  const API_BASE = "https://script.google.com/a/macros/casinomcw.com/s/AKfycbyrjyUKMnFfNlNHZiFBGdUqJ0yt06VB2ldsOlfTRW37oRRKv0hDd1LhA_05TSxPuuM9/exec";

  // JSONP
  function jsonp(params) {
    return new Promise((resolve) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      params.callback = cb;

      const qs = new URLSearchParams(params).toString();
      const s = document.createElement("script");
      s.src = API_BASE + "?" + qs;

      window[cb] = (data) => {
        resolve(data);
        try { delete window[cb]; } catch(e){}
        s.remove();
      };

      s.onerror = () => {
        resolve({ ok:false, error:"Network/API error" });
        try { delete window[cb]; } catch(e){}
        s.remove();
      };

      document.body.appendChild(s);
    });
  }

  const el = (id)=>document.getElementById(id);

  const store = {
    get token(){ return localStorage.getItem("token") || ""; },
    set token(v){ localStorage.setItem("token", v || ""); },
    get staffId(){ return localStorage.getItem("staffId") || ""; },
    set staffId(v){ localStorage.setItem("staffId", v || ""); },
    get name(){ return localStorage.getItem("name") || ""; },
    set name(v){ localStorage.setItem("name", v || ""); },
    get month(){ return localStorage.getItem("monthName") || ""; },
    set month(v){ localStorage.setItem("monthName", v || ""); },
  };

  function setMsg(id, text, isErr=false){
    const x = el(id);
    x.textContent = text || "";
    x.className = "text-sm " + (isErr ? "bad" : "muted");
  }

  function setDashMsg(text, type="muted"){
    const x = el("dashMsg");
    x.textContent = text || "";
    x.className = "text-sm mt-2 " + (type==="bad"?"bad":type==="good"?"good":type==="warn"?"warn":"muted");
  }

  function showLoggedIn(){
    el("loginCard").classList.add("hidden");
    el("dash").classList.remove("hidden");
    el("topRight").classList.remove("hidden");
    el("who").textContent = `${store.staffId} • ${store.name || "Staff"}`;
  }

  function showLoggedOut(){
    el("loginCard").classList.remove("hidden");
    el("dash").classList.add("hidden");
    el("topRight").classList.add("hidden");
    store.token = ""; store.staffId = ""; store.name = "";
  }

  function fmt(x){
    if (x === null || typeof x === "undefined") return "—";
    const n = Number(x);
    if (!isFinite(n)) return "—";
    return n.toFixed(2);
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function buildIncidents(data){
    const all = [];
    (data.monthly?.incidents || []).forEach(it => all.push({scope:"Monthly", ...it}));
    (data.weekly?.incidents || []).forEach(it => all.push({scope:"Weekly", ...it}));

    if (!all.length) {
      el("incidents").className = "mt-3 text-sm good";
      el("incidents").textContent = "No incidents ✅";
      return;
    }

    const html = all.map(i=>{
      const st = (i.status||"").toLowerCase();
      const cls =
        st.includes("absent") || st.includes("rule") ? "bad" :
        st.includes("warning") || st.includes("late") ? "warn" : "muted";

      return `<div class="mb-3">
        <div class="${cls} font-semibold">${escapeHtml(i.scope)}: ${escapeHtml(i.label)} — ${escapeHtml(i.status||"")}</div>
        ${i.notes ? `<div class="muted text-xs mt-1">${escapeHtml(i.notes)}</div>` : ""}
      </div>`;
    }).join("");

    el("incidents").className = "mt-3 text-sm";
    el("incidents").innerHTML = html;
  }

  function setLoading(on){
    const ids = ["mScore","wScore","fScore","qScore"];
    if (on){
      ids.forEach(id=>{
        el(id).innerHTML = `<div class="skeleton w-24 mt-2"></div>`;
      });
      el("incidents").textContent = "Loading...";
      el("incidents").className = "mt-3 text-sm muted";
    }
  }

  async function loadMonths(){
    setDashMsg("", "muted");

    const r = await jsonp({ action:"getMonths" });
    if (!r.ok) {
      setDashMsg(r.error || "Failed to load month sheets", "bad");
      return false;
    }

    const months = r.months || [];
    const sel = el("monthSelect");

    if (!months.length) {
      sel.innerHTML = `<option value="">No month sheets found</option>`;
      setDashMsg(
        "No month sheets detected. Your month tabs must include headers 'MonthStart' and 'StaffID'.",
        "warn"
      );
      return false;
    }

    sel.innerHTML = months.map(m=>`<option value="${escapeHtml(m.name)}">${escapeHtml(m.name)}</option>`).join("");

    const preferred =
      store.month && months.some(x=>x.name===store.month)
        ? store.month
        : (months[months.length-1]?.name || months[0]?.name || "");

    sel.value = preferred;
    store.month = preferred;

    setDashMsg("Month sheets loaded ✅", "good");
    return true;
  }

  async function loadDashboard(){
    if (!store.token) return;

    const monthName = el("monthSelect").value;

    // ✅ FIX: don’t call API if monthName empty
    if (!monthName) {
      setDashMsg("Select a month first (month sheets not detected).", "warn");
      return;
    }

    store.month = monthName;
    el("subtitle").textContent = `Selected Month: ${monthName}`;
    setLoading(true);

    const r = await jsonp({ action:"dashboard", token: store.token, monthName });

    // ✅ FIX: only logout if session expired; not for config issues
    if (!r.ok) {
      const msg = (r.error || "Error").toLowerCase();
      if (msg.includes("session expired") || msg.includes("please login")) {
        showLoggedOut();
        setMsg("loginMsg", r.error || "Please login again", true);
        return;
      }
      setDashMsg(r.error || "Failed to load dashboard", "bad");
      return;
    }

    setDashMsg("", "muted");

    el("mScore").textContent = fmt(r.monthly?.display);
    el("wScore").textContent = fmt(r.weekly?.display);
    el("fScore").textContent = fmt(r.final?.display);
    el("qScore").textContent = fmt(r.quarter?.display);

    const wk = (r.weekly?.weekEnd)
      ? `Latest Week: ${r.weekly.weekStart || ""} → ${r.weekly.weekEnd}`
      : "Latest weekly row";
    el("wHint").textContent = wk;

    const qMonths = (r.quarter?.monthsIncluded || []).join(", ");
    el("qHint").textContent = qMonths ? `Months: ${qMonths}` : "Quarter months auto";

    buildIncidents(r);
  }

  // ---------- EVENTS ----------
  el("btnLogin").addEventListener("click", async ()=>{
    setMsg("loginMsg","Logging in...");
    const staffId = el("staffId").value.trim();
    const password = el("password").value;

    if (!staffId || !password){
      setMsg("loginMsg","Enter StaffID and password", true);
      return;
    }

    // init auth (safe)
    await jsonp({ action:"initAuth" });

    const r = await jsonp({ action:"login", staffId, password });
    if (!r.ok){
      setMsg("loginMsg", r.error || "Login failed", true);
      return;
    }

    store.token = r.token;
    store.staffId = r.staffId;
    store.name = r.name || "";

    showLoggedIn();

    const ok = await loadMonths();
    // ✅ Only load dashboard if month sheets exist
    if (ok) await loadDashboard();
  });

  el("btnLogout").addEventListener("click", ()=>{
    showLoggedOut();
    setMsg("loginMsg","Logged out.");
  });

  el("btnRefresh").addEventListener("click", loadDashboard);
  el("monthSelect").addEventListener("change", loadDashboard);

  el("btnChangePass").addEventListener("click", async ()=>{
    setMsg("passMsg","Updating...");
    const oldPassword = el("oldPass").value;
    const newPassword = el("newPass").value;

    if (!oldPassword || !newPassword){
      setMsg("passMsg","Enter old + new password", true);
      return;
    }

    const r = await jsonp({ action:"changePassword", token: store.token, oldPassword, newPassword });
    if (!r.ok){
      setMsg("passMsg", r.error || "Failed", true);
      return;
    }

    setMsg("passMsg","Password updated ✅");
    el("oldPass").value = "";
    el("newPass").value = "";
  });

  // Auto restore session
  (async function boot(){
    if (store.token && store.staffId){
      showLoggedIn();
      const ok = await loadMonths();
      if (ok) await loadDashboard();
    }
  })();
</script>
</body>
</html>
