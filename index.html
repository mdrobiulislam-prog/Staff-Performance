<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Staff Score Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root { color-scheme: dark; }
    body { background: radial-gradient(1200px 600px at 20% 0%, rgba(99,102,241,.18), transparent 60%),
                     radial-gradient(900px 500px at 90% 10%, rgba(14,165,233,.12), transparent 55%),
                     #070b18; }

    /* ✅ Safety: nothing should block clicks */
    * { pointer-events: auto; }

    .card { background: rgba(15, 23, 42, .72); border: 1px solid rgba(148,163,184,.14); box-shadow: 0 10px 35px rgba(0,0,0,.35); }
    .chip { border: 1px solid rgba(148,163,184,.18); background: rgba(2,6,23,.55); }
    .btn { border: 1px solid rgba(148,163,184,.18); background: rgba(2,6,23,.55); cursor:pointer; }
    .btn:hover { background: rgba(30,41,59,.6); }
    .btn-primary { background: rgba(99,102,241,.85); border-color: rgba(99,102,241,.35); cursor:pointer; }
    .btn-primary:hover { background: rgba(99,102,241,.95); }
    .inp { background: rgba(2,6,23,.55); border: 1px solid rgba(148,163,184,.18); }
    .tableWrap { border: 1px solid rgba(148,163,184,.14); border-radius: 18px; overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; font-weight: 600; font-size: 12px; letter-spacing: .02em; color: rgb(203 213 225); background: rgba(2,6,23,.65); border-bottom: 1px solid rgba(148,163,184,.14); }
    td { border-bottom: 1px solid rgba(148,163,184,.08); color: rgb(226 232 240); font-size: 13px; }
    tr:hover td { background: rgba(2,6,23,.35); }
    .muted { color: rgb(148 163 184); }
    .danger { color: rgb(248 113 113); }
    .warn { color: rgb(251 191 36); }
    .ok { color: rgb(74 222 128); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .toast { position: fixed; right: 16px; bottom: 16px; z-index: 9999; pointer-events:none; }
    .toast > * { pointer-events:auto; }
    .hidden { display:none !important; }

    @media (max-width: 640px){
      .gridCards { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; }
    }

    /* ✅ FORCE LOGIN AREA ABOVE ANY OVERLAY */
    #loginCard { position: relative; z-index: 5000; }
    #btnLogin { position: relative; z-index: 6000; pointer-events: auto !important; cursor: pointer !important; }
  </style>
</head>

<body class="min-h-screen text-slate-100">
  <div class="max-w-[1200px] mx-auto px-4 py-10">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h1 class="text-3xl font-bold tracking-tight">Staff Score Dashboard</h1>
        <p class="muted mt-1 text-sm">Live view • Monthly + Weekly • Quarterly • Incidents • Private login</p>
      </div>
      <div id="topRight" class="hidden items-center gap-2">
        <div class="chip rounded-full px-3 py-1 text-xs">
          <span id="whoami" class="muted"></span>
        </div>
        <button id="btnLogout" class="btn rounded-full px-3 py-1 text-xs" type="button">Logout</button>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="loginCard" class="card rounded-2xl mt-8 p-6">
      <div class="grid md:grid-cols-2 gap-6 items-center">
        <div>
          <h2 class="text-lg font-semibold">Login</h2>
          <p class="muted text-sm mt-1">Use your StaffID + password.</p>
          <p class="muted text-xs mt-3">(Default password is NOT shown here. You will share it manually to staff.)</p>
          <p class="muted text-xs mt-2">If login fails, ask admin to re-deploy / sync AUTH in Apps Script.</p>
        </div>

        <div class="space-y-3">
          <div>
            <label class="muted text-xs">StaffID</label>
            <input id="loginStaffId" class="inp w-full rounded-xl px-3 py-2 mt-1 outline-none" placeholder="e.g. S016" />
          </div>
          <div>
            <label class="muted text-xs">Password</label>
            <input id="loginPass" type="password" class="inp w-full rounded-xl px-3 py-2 mt-1 outline-none" placeholder="••••••••" />
          </div>
          <button id="btnLogin" class="btn-primary w-full rounded-xl py-2 font-semibold" type="button">Login</button>
          <div id="loginErr" class="text-sm danger hidden"></div>
        </div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dash" class="hidden">
      <div class="card rounded-2xl mt-8 p-5">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
          <div>
            <h3 class="font-semibold">Your Live Scores</h3>
            <div class="muted text-xs mt-1">Selected: <span id="selectedLabel" class="mono"></span></div>
            <div id="hintBox" class="mt-2 text-xs warn hidden"></div>
          </div>

          <div class="flex flex-wrap items-center gap-2">
            <select id="monthSelect" class="inp rounded-xl px-3 py-2 text-sm outline-none"></select>
            <button id="btnRefresh" class="btn rounded-xl px-3 py-2 text-sm" type="button">Refresh</button>
            <button id="btnExportMe" class="btn rounded-xl px-3 py-2 text-sm" type="button">Export My Report</button>
            <button id="btnExportCSV" class="btn rounded-xl px-3 py-2 text-sm" type="button">Export CSV</button>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mt-4 gridCards">
        <div class="card rounded-2xl p-5">
          <div class="muted text-xs">Monthly Score</div>
          <div id="kpiMonthly" class="text-3xl font-bold mt-2">—</div>
          <div class="muted text-xs mt-1">Shown out of <span class="mono">4</span></div>
        </div>

        <div class="card rounded-2xl p-5">
          <div class="muted text-xs">Weekly Score</div>
          <div id="kpiWeekly" class="text-3xl font-bold mt-2">—</div>
          <div id="kpiWeeklyNote" class="muted text-xs mt-1">Avg of 0 weeks</div>
        </div>

        <div class="card rounded-2xl p-5">
          <div class="muted text-xs">Final Average</div>
          <div id="kpiFinal" class="text-3xl font-bold mt-2">—</div>
          <div class="muted text-xs mt-1">(Monthly + Weekly) / 2</div>
        </div>

        <div class="card rounded-2xl p-5">
          <div class="muted text-xs">Quarter Score</div>
          <div id="kpiQuarter" class="text-3xl font-bold mt-2">—</div>
          <div id="kpiQuarterNote" class="muted text-xs mt-1">Months: —</div>
        </div>
      </div>

      <div class="mt-6 muted text-sm">
        Dashboard loaded. If you still can’t login, open browser DevTools → Console and tell me the error line.
      </div>
    </div>
  </div>

  <div class="toast">
    <div id="toast" class="hidden card rounded-xl px-4 py-3 text-sm"></div>
  </div>

<script>
  // ✅ YOUR WEB APP
  const GAS_URL = "https://script.google.com/a/macros/casinomcw.com/s/AKfycbwWbjQVOy1PQfQvro4H5ogz2_WBpoZiSwCCg2zRbAtCmehqj3hB7DKcGKHikWgHfASF/exec";

  const $ = (id) => document.getElementById(id);

  function toast(msg){
    const el = $("toast");
    el.textContent = msg;
    el.classList.remove("hidden");
    setTimeout(()=> el.classList.add("hidden"), 2500);
  }

  async function api(action, payload = {}) {
    const r = await fetch(GAS_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({ action, ...payload })
    });
    const t = await r.text();
    return JSON.parse(t);
  }

  async function doLogin(){
    const staffId = $("loginStaffId").value.trim();
    const password = $("loginPass").value;

    $("loginErr").classList.add("hidden");
    if (!staffId || !password) {
      $("loginErr").textContent = "Please enter StaffID and password.";
      $("loginErr").classList.remove("hidden");
      return;
    }

    toast("Logging in…");
    try {
      const res = await api("login", { staffId, password });
      if (!res.success) throw new Error(res.error || "Login failed");

      // ✅ just to prove button works
      toast("Login success ✅");
    } catch (e) {
      $("loginErr").textContent = e.message || String(e);
      $("loginErr").classList.remove("hidden");
    }
  }

  // ✅ attach click
  window.addEventListener("DOMContentLoaded", () => {
    $("btnLogin").addEventListener("click", doLogin);
    $("loginPass").addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });
  });
</script>
</body>
</html>
